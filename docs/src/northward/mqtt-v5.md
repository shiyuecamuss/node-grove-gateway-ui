---
title: '北向 MQTT v5'
description: 'NG Gateway 北向 MQTT v5 对接指南：连接与会话策略、主题规范、载荷格式（JSON/Proto）、上下行闭环与可靠性语义。'
---

# 北向 MQTT v5

北向 MQTT v5 是 NG Gateway 面向平台的默认对接链路之一：它把统一数据模型的 telemetry/event 可靠地发布到平台，同时接收平台侧下行指令并形成闭环。

> 最佳实践：先明确“语义”，再谈“实现”。在现场网络不稳定时，**至少一次** 是常态，平台侧必须具备幂等/去重策略。

## 本章范围

- **包含**：会话语义、连接策略、主题建议、载荷格式与版本化、上行/下行闭环、失败处理策略
- **不包含**：具体平台（ThingsBoard/自研平台）的定制主题与字段（建议放在对应插件文档中）

## 会话与可靠性语义

需要在配置与平台侧统一的关键项：

- **QoS**：吞吐优先 vs 可靠优先如何取舍
- **Session**：是否使用持久会话（clean start/session expiry）
- **离线策略**：断网时缓存/丢弃/降级（必须可配置）
- **重连与退避**：指数退避 + 抖动，避免重连风暴

## 主题（Topic）设计建议

建议主题具备可路由性、可按租户/应用隔离、可按设备聚合：

```text
up/telemetry/{tenant}/{gateway_id}/{device_id}
up/event/{tenant}/{gateway_id}/{device_id}
down/command/{tenant}/{gateway_id}/{device_id}
down/config/{tenant}/{gateway_id}
```

> 说明：具体命名以你们平台规范为准，但要保证：**订阅范围可控**、**权限易配置**、**迁移成本低**。

## 载荷格式（JSON / Proto）

推荐策略：

- **JSON**：开发/调试友好；适合低频或需要快速定位问题的现场
- **Proto**：带宽与 CPU 更友好；适合高频点位与批量上报

版本化建议：

- 载荷里包含 `schema_version`
- 平台侧按版本兼容解析，避免“字段变更即全量升级”

## 上行链路（Telemetry / Event）

推荐把上行拆成两类：

- **Telemetry**：点位值（可批量）
- **Event**：状态变化、告警、驱动错误摘要、配置变更等

关键点：

- 批量上报要可配置（批大小、flush 间隔、最大延迟）
- 对高频小包场景，优先做边缘侧聚合/去抖，减少云端压力

## 下行链路（Command / Config）与闭环

下行链路必须有明确的闭环语义：

- 平台发命令 → 网关校验/鉴权 → 调用 southward 执行 → 回传 ack/result（成功/失败/超时）
- 对“可能重复投递”的命令，平台应附带 `command_id`，网关/平台侧做幂等

## 失败处理策略（必须写清楚）

- publish 失败：重试/退避/丢弃/落盘（可配置）
- 下行执行失败：错误分类（可重试/不可重试/需要重连/参数非法）
- 队列背压：当下游拥塞时，如何保护系统不 OOM

## 下一步阅读

- [`架构概览`](../overview/architecture.md)：背压与故障隔离如何贯穿南北向
- [`南向总览`](../southward/overview.md)：采集与解析如何产生统一模型事件
