---
title: '南向总览'
description: 'NG Gateway 南向（southward）体系概览：驱动模型、设备连接、采集策略、解析容错与性能最佳实践。'
---

# 南向总览

南向（southward）负责把“现场设备世界”接入网关：连接管理、协议读写、解析容错、点位映射，并将结果标准化为统一数据模型供核心管线与北向使用。

> 设计原则：**南向只解决“如何可靠采集与解析”**，不要在驱动里绑定北向协议、业务规则或平台差异。

## 你将从本章获得什么

- 清晰理解 **driver / device / point / collector** 的职责边界
- 知道南向的 **容错策略** 应该写在哪里，如何避免现场噪声拖垮网关
- 知道在高吞吐采集场景下如何做 **批量读写、预分配、零拷贝** 与背压协作

## 体系结构（逻辑视图）

```text
Device Config
  → Collector (poll/subscribe schedule)
    → Driver (connect/read/write/parse)
      → Unified Model (PointValue / Events)
        → Core Pipeline (bounded channels)
```

## 驱动模型（Driver Model）

一个南向驱动通常需要覆盖：

- **连接层**：串口 / TCP / UDP / 自定义介质
- **会话层**：握手、心跳、重连、状态机
- **协议层**：帧编解码、校验、分包/粘包处理
- **点位层**：点位地址映射、批量读取策略、读写权限
- **容错层**：超时、重试、退避、错误分类与恢复

## 采集策略（Collector Strategy）

南向采集建议由 collector 统一调度，常见模式：

- **轮询（Polling）**：按周期读点位；支持批量与拆分；支持优先级。
- **订阅（Subscription）**：对支持订阅的协议维持订阅，处理变化推送（如 OPC UA）。

最佳实践：

- **有界队列**：设备/通道级隔离队列，避免单设备异常扩散。
- **节流与退避**：连续失败应指数退避，避免重连风暴。
- **批量读取可配置**：批大小、并发度、超时必须能按现场调参。

## 解析容错（Parsing Tolerance）

现场常见异常：半包、噪声、CRC 错、乱序、设备忙、短暂断电。

最低要求：

- **解析失败不 panic**：错误必须携带设备标识、帧计数、地址等上下文。
- **可恢复**：对坏帧应丢弃并重新同步帧头；对短暂超时应可重试。
- **错误语义可操作**：区分“可重试/不可重试/需要重连/需要降级”。

## 性能最佳实践（Performance）

- **批量读写优先**：减少往返次数与帧开销。
- **预分配**：热点路径用 `Vec::with_capacity`，避免循环内反复分配。
- **零拷贝**：解析尽量基于 `&[u8]`，必要时使用 `bytes::Bytes` 复用缓冲区。
- **避免全局锁**：以设备/通道为粒度隔离状态，减少锁竞争。

## 下一步阅读

- [`驱动开发`](../dev/driver-dev.md)：如何写一个南向驱动（接口、测试、性能与容错）
- [`架构概览`](../overview/architecture.md)：从系统视角理解背压与故障隔离
